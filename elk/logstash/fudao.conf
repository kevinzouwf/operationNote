# ============================================================
# INPUT
# ============================================================
input {
    beats {
        port => 5044
        }

}

# ============================================================
# FILTER
# ============================================================

filter {
#-----------------------------------------------------------
# fudao_nginx_access
    if [type] =~ ".*_access" {
    	grok {
		match => { "message" => "%{IPV4:frontend_addr} %{USER:ident|-} %{USER:auth|-} \[%{HTTPDATE:timestamp}\] \"(?:%{WORD:method} %{NOTSPACE:request} (?:HTTP/%{NUMBER:http_version})?|-)\" %{NUMBER:response} (?:%{NUMBER:bytes}) %{NOTSPACE:request_body} %{QS:referrer} \"(?:response\s*%{NOTSPACE:upstream_response_time})\" \"(?:request\s*%{NOTSPACE:request_time})\"%{QS:agent} \"(%{IPV4:clientip}|-)\" \"%{NOTSPACE:http_logid}\" \"%{NOTSPACE:http_trace}\""}
       	 }
	geoip {
    		source => "clientip"
                target => "geoip" 
                add_field => [ "[geoip][coordinates]", "%{[geoip][longitude]}" ]
                add_field => [ "[geoip][coordinates]", "%{[geoip][latitude]}"  ]
                database => "/data/soft/logstash_5044/geoip/GeoLite2-City.mmdb" 
         }
	 mutate {
                    convert => { "upstream_response_time" => "float" }
                    convert => { "request_time" => "float" }
                    convert => { "[geoip][coordinates]" => "float" }
         }

	}
# fudao_nginx_error
    if [type] == "fudao_nginx_error" {
	grok {
             match => { "messages" => "(?<message>.*)"}
             }
	}
#-----------------------------------------------------------
#fudao_crm: servicelog
	if [type] =~ ".*servicelog" {
        grok {
              match => { "message" => "\[%{TIMESTAMP_ISO8601:timestamp}\] %{RUBY_LOGLEVEL:loglevel} %{NOTSPACE:application} \{\"response_time\":(?<response_time>%{NUMBER}),\"request_uri\":\"(?<request_uri>.*)\",\"request_header\":(?<request_header>\{.*\}),\"request_body\":(?<request_body>\{.*\}),\"response_body\":(?<response_body>\{.*\})\}"}
             }
	    mutate {
                    convert => { "response_time" => "float" }
                  }
        }
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#requestlog
    if [type] =~ ".*requestlog" {
       grok {    
             match => { "message" => "\[%{TIMESTAMP_ISO8601:timestamp}\] %{RUBY_LOGLEVEL:loglevel} %{NOTSPACE:application} \{\"response_time\":%{BASE10NUM:request_time},\"request_uri\":\"(?<request_uri>.*)\",\"request_header\":(?<request_header>\{.*\}),\"request_body\":(?<request_body>\{.*\}),\"response_body\":(?<response_body>\{.*\})\}"}
	}
	    mutate {
                    convert => { "request_time" => "float" }
                  }
    }
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
}

#=============================================================================
# OUTPUT
#=============================================================================

output {
#-----------------------------------------------------------------------------
       if [type] == "fudao_student_assistant_access" {
	elasticsearch {
                hosts => ['10.9.199.212', '10.9.90.46', '10.9.194.129', '10.9.156.25', '10.9.155.129']
       	 	index => "logstash-fudao_student_assistant_access-%{+YYYY.MM.dd}"
                      }
       }
       if [type] == "fudao_student_app_access" {
	elasticsearch {
                hosts => ['10.9.199.212', '10.9.90.46', '10.9.194.129', '10.9.156.25', '10.9.155.129']
       	 	index => "logstash-fudao_student_app_access-%{+YYYY.MM.dd}"
                      }
       }
       if [type] == "fudao_student_android_access" {
	elasticsearch {
                hosts => ['10.9.199.212', '10.9.90.46', '10.9.194.129', '10.9.156.25', '10.9.155.129']
       	 	index => "logstash-fudao_student_android_access-%{+YYYY.MM.dd}"
                      }
       }

       if [type] == "fudao_nginx_access" {
	elasticsearch {
                hosts => ['10.9.199.212', '10.9.90.46', '10.9.194.129', '10.9.156.25', '10.9.155.129']
       	 	index => "logstash-fudao_nginx_access-%{+YYYY.MM.dd}"
                      }
       }

       if [type] == "fudao_nginx_error" {
	elasticsearch {
                hosts => ['10.9.199.212', '10.9.90.46', '10.9.194.129', '10.9.156.25', '10.9.155.129']
       	 	index => "fudao_nginx_error-%{+YYYY.MM.dd}"
                      }
       }
#-----------------------------------------------------------------------------
#servicelog output to files
	if [type] == "fudao_servicelog" {
	elasticsearch {
                hosts => ['10.9.199.212', '10.9.90.46', '10.9.194.129', '10.9.156.25', '10.9.155.129']
       	 	index => "fudao_servicelog-%{+YYYY.MM.dd}"
                      }
        }
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#requestlog output to files
       if [type] == "requestlog" {
	elasticsearch {
                hosts => ['10.9.199.212', '10.9.90.46', '10.9.194.129', '10.9.156.25', '10.9.155.129']
       	 	index => "fudao_requestlog-%{+YYYY.MM.dd}"
                      }
       }
       
#-----------------------------------------------------------------------------
#fudao_crm:requestlog
       if [type] == "fudao_callcenter_requestlog" {
        elasticsearch {
                hosts => ['10.9.199.212', '10.9.90.46', '10.9.194.129', '10.9.156.25', '10.9.155.129']
                index => "fudao_callcenter_requestlog-%{+YYYY.MM.dd}"
                      }
       }
       if [type] == "fudao_crm_requestlog" {
        elasticsearch {
                hosts => ['10.9.199.212', '10.9.90.46', '10.9.194.129', '10.9.156.25', '10.9.155.129']
                index => "fudao_crm_requestlog-%{+YYYY.MM.dd}"
                      }
       }
       if [type] == "fudao_clue_requestlog" {
        elasticsearch {
                hosts => ['10.9.199.212', '10.9.90.46', '10.9.194.129', '10.9.156.25', '10.9.155.129']
                index => "fudao_clue_requestlog-%{+YYYY.MM.dd}"
                      }
       }
#fudao_crm:servicelog
#
       if [type] == "fudao_crm_servicelog" {
        elasticsearch {
                hosts => ['10.9.199.212', '10.9.90.46', '10.9.194.129', '10.9.156.25', '10.9.155.129']
                index => "fudao_crm_servicelog-%{+YYYY.MM.dd}"
                      }
       }
       if [type] == "fudao_clue_servicelog" {
        elasticsearch {
                hosts => ['10.9.199.212', '10.9.90.46', '10.9.194.129', '10.9.156.25', '10.9.155.129']
                index => "fudao_clue_servicelog-%{+YYYY.MM.dd}"
                      }
       }
       if [type] == "fudao_callcenter_servicelog" {
        elasticsearch {
                hosts => ['10.9.199.212', '10.9.90.46', '10.9.194.129', '10.9.156.25', '10.9.155.129']
                index => "fudao_callcenter_servicelog-%{+YYYY.MM.dd}"
                      }
       }
#-----------------------------------------------------------------------------
       if  [type] =~ ".*_access" and [response]  and [response] not in ['200','301','302','304','400','405'] {
       exec {
          command => "/data/soft/logstash_5044/bin/nginx-50x.py  %{host} %{request} %{message}"
          }
       }
}
